#!/bin/bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="${SCRIPT_DIR}/config.ini"
TARGET_DIR="${HOME}/.claude"

parse_ini() {
    local file="$1"
    local section=""
    while IFS= read -r line || [[ -n "$line" ]]; do
        line="${line%%#*}"
        line="${line%%[[:space:]]}"
        [[ -z "$line" ]] && continue
        if [[ "$line" =~ ^\[([^\]]+)\]$ ]]; then
            section="${BASH_REMATCH[1]}"
        elif [[ "$line" =~ ^([^=]+)=(.*)$ ]]; then
            local key="${BASH_REMATCH[1]}"
            local value="${BASH_REMATCH[2]}"
            key="${key%%[[:space:]]}"
            key="${key##[[:space:]]}"
            value="${value%%[[:space:]]}"
            value="${value##[[:space:]]}"
            value="${value/#\~/$HOME}"
            printf -v "CONFIG_${section^^}_${key^^}" '%s' "$value"
        fi
    done < "$file"
}

substitute_vars() {
    local content="$1"
    content="${content//__ARRIVALS_DIR__/${CONFIG_PATHS_ARRIVALS_DIR}}"
    content="${content//__BOOKS_DIR__/${CONFIG_PATHS_BOOKS_DIR}}"
    echo "$content"
}

install_file() {
    local src="$1"
    local dest="$2"
    local content
    content="$(cat "$src")"
    content="$(substitute_vars "$content")"
    mkdir -p "$(dirname "$dest")"
    echo "$content" > "$dest"
    echo "Installed: $dest"
}

main() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo "Error: config.ini not found at $CONFIG_FILE"
        exit 1
    fi

    parse_ini "$CONFIG_FILE"

    echo "Installing dewey book cataloging agent..."
    echo "  Arrivals: ${CONFIG_PATHS_ARRIVALS_DIR}"
    echo "  Books: ${CONFIG_PATHS_BOOKS_DIR}"
    echo ""

    mkdir -p "${TARGET_DIR}/agents"
    mkdir -p "${TARGET_DIR}/skills"

    install_file "${SCRIPT_DIR}/agents/rename-books.md" "${TARGET_DIR}/agents/rename-books.md"

    for skill_dir in "${SCRIPT_DIR}/skills/"*/; do
        skill_name="$(basename "$skill_dir")"
        mkdir -p "${TARGET_DIR}/skills/${skill_name}"
        for file in "${skill_dir}"*; do
            [[ -f "$file" ]] || continue
            install_file "$file" "${TARGET_DIR}/skills/${skill_name}/$(basename "$file")"
        done
    done

    if [[ -f "${SCRIPT_DIR}/data/codes.md" ]]; then
        mkdir -p "${TARGET_DIR}/data"
        cp "${SCRIPT_DIR}/data/codes.md" "${TARGET_DIR}/data/codes.md"
        echo "Installed: ${TARGET_DIR}/data/codes.md"
    fi

    echo ""
    echo "Installation complete."
    echo "Use: claude --agent rename-books"
}

main "$@"
